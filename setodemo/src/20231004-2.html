<html>
  <head>
    <!-- <script src="https://aframe.io/releases/1.2.0/aframe.js"></script> -->
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta charset="utf-8" />
    <meta name="author" content="エスユーエス名古屋" />
    <meta name="description" content="エスユーエス名古屋WebAR" />
    <meta property="og:image" content="" />
    <meta property="og:description" content="エスユーエス名古屋WebAR" />
    <meta property="og:title" content="エスユーエス名古屋WebAR" />
    <meta property="og:site_name" content="エスユーエス名古屋WebAR" />
    <meta property="og:locale" content="ja_JP" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta http-equiv="Pragma" content="no-store" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Expires" content="0" />
    <meta
      aframe-injected=""
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no,user-scalable=no,minimal-ui,viewport-fit=cover"
    />
    <meta aframe-injected="" name="theme-color" content="black" />
    <script src="./js/aframe.1.2.0.js"></script>
    <script src="./js/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="./js/model-viewer.js"></script>
    <script src="./js/background-gradient.js"></script>
    <script src="https://unpkg.com/aframe-supercraft-loader@1.1.3/dist/aframe-supercraft-loader.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <meta charset="utf-8" />
    <title>エスユーエス名古屋WebAR</title>
  </head>
  <body style="margin: 0; overflow: hidden">
    <div id="loader">
      <p>Loading...</p>
    </div>
    <a-scene
      embedded
      arjs
      vr-mode-ui="enabled: false"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable"
      model-viewer="gltfModel: #test;"
    >
      <!-- アセット一覧 -->
      <a-assets>
        <audio id="se_a" muted playinline src="./sound/dragon.mp3?1"></audio>
        <audio id="se_b" muted playinline src="./sound/dragon.mp3?2"></audio>

        <!-- 表示するもの -->
        <a-asset-item
          id="brachio"
          src="./obj/fukui/WalkingBrakio_3m.glb"
        ></a-asset-item>
      </a-assets>

      <!-- マーカーを設定する -->
      <a-marker
        preset="custom" 
        id="base"
        type="pattern"
        url="./pattern-ar-test.patt"
        emitevents="true"
        markerevent1
      ></a-marker>

      <!-- aframe-orbit-controlsのプロパティを記述 -->
      <a-entity
        camera
        orbit-controls="target: 0 1.6 0; maxPolarAngle:180; minDistance: 0.5; maxDistance: 200; initialPosition: 0 0 40"
      ></a-entity>

      <!-- 3Dモデルを読み込んで、位置やスケールなど定義する -->
      <a-entity
        visible="false"
        gltf-model="#brachio"
        id="test"
        position="0 -2 -10"
        rotation="0 5 5"
        scale="1 1 1"
        animation-mixer
      ></a-entity>
    </a-scene>

    <div
      id="info-message"
      class="a-info-message d-flex align-items-center rounded"
    >
      <div id="close-btn" class="a-close-button-info">X</div>
      <div class="w-100 text-center">
        <img src="./img/sus.png" alt="susロゴ" width="90%" /><br />
        <p class="fw-bold">エスユーエス名古屋WebARデモ</p>
        <p class="fw-bold">カメラでマーカーを読み込んでください。</p>
        <button id="start-btn" type="button" class="btn btn-primary btn-lg">
          スタート!!
        </button>
      </div>
    </div>

    <script>
      let testEntityAdded = false;
      let markerLostflg = false;

      AFRAME.registerComponent("markerevent1", {
        init: function () {
          let marker = this.el;
          var camera = document.getElementById("camera");

          marker.addEventListener("markerFound", function () {
            console.log("markerFound");
            if (!testEntityAdded) {
              console.log("markerFound");

              // 3Dモデルを追加する
              const entity = document.querySelector("#test");
              entity.setAttribute("visible", true);

              // 鳴き声
              var display_audio = document.getElementById("se_a");
              display_audio.pause();
              display_audio.currentTime = 0;
              display_audio.play();
            }
            testEntityAdded = true;
            markerLostflg = false;
          });

          marker.addEventListener("markerLost", function () {
            console.log("markerLost");
          });
        },
      });

      var a_scene = document.querySelector("a-scene");
      var run = function () {
        //glTFの表示が暗くなる問題に対処
        document.querySelector("a-scene").renderer.gammaOutput = true;

        document.getElementById("close-btn").addEventListener("click", () => {
          setMuteAudio(false); // ミュートはずし
          document.getElementById("info-message").remove();
        });
        document.getElementById("start-btn").addEventListener("click", () => {
          setMuteAudio(false); // ミュートはずし
          document.getElementById("info-message").remove();
        });
        document.getElementById("loader").classList.add("hidden");
      };

      if (a_scene.hasLoaded) {
        run();
      } else {
        window.onload = a_scene.addEventListener("loaded", run);
      }

      function setMuteAudio(is_muted) {
        console.log("setMuteButton");
        var audios = document.body.querySelectorAll("audio");
        audios.forEach((audio) => {
          console.log(audio);
          audio.muted = is_muted == true ? true : false;
        });
      }
    </script>
  </body>
</html>
