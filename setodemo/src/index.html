<html>
    <head>
        <!-- <script src="https://aframe.io/releases/1.2.0/aframe.js"></script> -->
        <meta charset="utf-8" />
        <meta name="author" content="エスユーエス">
        <meta name="description" content="瀬戸まるっとミュージアムAR">
        <meta property="og:image" content="">
        <meta property="og:description" content="瀬戸まるっとミュージアムAR">
        <meta property="og:title" content="瀬戸まるっとミュージアムAR">
        <meta property="og:site_name" content="瀬戸まるっとミュージアムAR" />
        <meta property="og:locale" content="ja_JP" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta http-equiv="Pragma" content="no-store">
        <meta http-equiv="Cache-Control" content="no-store">
        <meta http-equiv="Expires" content="0">
        <meta aframe-injected="" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no,user-scalable=no,minimal-ui,viewport-fit=cover">
        <meta aframe-injected="" name="theme-color" content="black">
        <script src="./js/aframe.1.2.0.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="css/style.css">
        <meta charset="utf-8">
        <title>ARデモ</title>
    </head>
    <body style="margin: 0; overflow: hidden">
        <div id="loader">
            <p>Loading...</p>
        </div>
        <a-scene embedded arjs vr-mode-ui="enabled: false" cursor="rayOrigin: mouse" raycaster="objects: .clickable">

            <!-- アセット一覧 -->
            <a-assets>
                <audio id="se_a" muted playinline src="./sound/a.mp3"></audio>
                <audio id="se_b" muted playinline src="./sound/b.mp3"></audio>

                <!-- 表示するもの -->>
                <a-asset-item id="setochan" src="./seto/seto.glb"></a-asset-item>
                <audio id="sample" muted playinline src="./sound/202203sample.mp3"></audio>
                <img id="yakimonokoujou" src="./img/YakimonoKoujou.png">
            </a-assets>

            <!-- マーカーと表示したいオブジェクト -->
            <a-marker preset="custom" type="pattern" url='./pattern-ar-test.patt' markerevent1></a-marker>
            <a-marker preset="custom" type="pattern" url='./pattern-seto.patt' markerevent2></a-marker>
            
            <!-- カメラ -->
            <a-entity id="camera" camera></a-entity>

            <a-entity cursor="rayOrigin: mouse"></a-entity>
        </a-scene>

        <div id="info-message" class="a-info-message d-flex align-items-center">
            <div id="close-btn" class="a-close-button-info">X</div>
            <div class="w-100 text-center">
                瀬戸ARデモ<br />
                <button id="start-btn" type="button" class="btn btn-primary btn-lg">スタート!!</button>
            </div>
        </div>

        <script>
            var display_audio = document.getElementById('se_a');
            AFRAME.registerComponent('markerevent1', {
                init: function () 
                {
                    let marker = this.el;
                    var se_a = document.getElementById('se_a');
                    var se_b = document.getElementById('se_b');
                    var sample = document.getElementById('sample');
                    var camera = document.getElementById('camera');
                    
                    marker.addEventListener('markerFound', function() {
                        console.log("markerFound");
                        var scene = document.querySelector('a-scene');
                        if(document.getElementById("info-message") != null) return;
                        if(document.getElementById("setochan-model") != null) return;
                        if(document.getElementById('setochan-model2') != null) document.getElementById('setochan-model2').remove();
                        display_audio.pause();
                        display_audio.currentTime = 0;
                        display_audio = document.getElementById('sample');
                        display_audio.play();
                        
                        // モデルの表示
                        var a_entity = document.createElement('a-entity');
                        a_entity.setAttribute('id', 'setochan-model');
                        a_entity.setAttribute('position', '0 -1.5 -3');
                        a_entity.setAttribute('rotation', '-20 0 0');
                        var model = document.createElement('a-gltf-model');
                        model.setAttribute('id', 'setochan-model-inner');
                        model.setAttribute('src', '#setochan');
                        model.setAttribute('scale', '1.25 1.25 1.25');
                        model.setAttribute('position', '0 0 0');
                        model.setAttribute('animation', 'property: rotation; from: 0 0 0; to: 0 360 0; loop: true; dur: 3000; easing: linear;');
                        a_entity.appendChild(model);
                        scene.appendChild(a_entity);

                        // 画像の表示
                        var img = document.createElement('a-image');
                        img.setAttribute('id', 'yakimonokoujou-img');
                        img.setAttribute('src', '#yakimonokoujou');
                        img.setAttribute('scale', '1.7 4 1');
                        img.setAttribute('position', '0 0 -5');
                        scene.appendChild(img);

                    });
    
                    marker.addEventListener('markerLost', function() {
                        console.log("markerLost");
                    });
                }
            });

            AFRAME.registerComponent('markerevent2', {
                init: function () 
                {
                    let marker = this.el;
                    var se_a = document.getElementById('se_a');
                    var se_b = document.getElementById('se_b');
                    var camera = document.getElementById('camera');
                    
                    marker.addEventListener('markerFound', function() {
                        console.log("markerFound");

                        if(document.getElementById("info-message") != null) return;
                        if(document.getElementById("setochan-model2") != null) return;
                        if(document.getElementById('setochan-model') != null) document.getElementById('setochan-model').remove();
                        if(document.getElementById('yakimonokoujou-img') != null) document.getElementById('yakimonokoujou-img').remove();

                        var scene = document.querySelector('a-scene');
                        display_audio.pause();
                        display_audio.currentTime = 0;
                        display_audio = document.getElementById('se_b');
                        display_audio.play();

                        var model = document.createElement('a-gltf-model');
                        model.setAttribute('id', 'setochan-model2');
                        model.setAttribute('src', '#setochan');
                        model.setAttribute('scale', '1.25 1.25 1.25');
                        model.setAttribute('position', '0 -0.5 -3');
                        model.setAttribute('animation', 'property: position; from: 0 -0.8 -3; to: 0 -0.1 -3; dir: alternate; dur: 1000; loop: true;');
                        scene.appendChild(model);
                    });
    
                    marker.addEventListener('markerLost', function() {
                        console.log("markerLost");
                    });
                }
            });
            

            /*
            AFRAME.registerComponent('box', {
                init: function () 
                {
                    let box = this.el;
                    console.log(this.el);
                    // var scene = document.querySelector('a-scene');

                    box.addEventListener('touchStart', function() {
                        console.log("click");
                        console.log(box);
                        var color = (Math.random() * 0xFFFFFF | 0).toString(16);
                        var randomColor = "#" + ("000000" + color).slice(-6);
                        box.setAttribute('color', randomColor);
                    });
                }
            });
            */

            var a_scene = document.querySelector('a-scene');
            var run = function () {
                console.log("aaaa");

                document.getElementById('close-btn').addEventListener('click', () =>{
                    setMuteAudio(false);    // ミュートはずし
                    document.getElementById('info-message').remove();
                });
                document.getElementById('start-btn').addEventListener('click', () =>{
                    setMuteAudio(false);    // ミュートはずし
                    document.getElementById('info-message').remove();

                });
                document.getElementById("loader").classList.add("hidden");
            }

            if (a_scene.hasLoaded) {
                run();
            } else {
                window.onload = a_scene.addEventListener('loaded', run);
            }

            function setMuteAudio(is_muted) {
                console.log("setMuteButton");
                var audios = document.body.querySelectorAll("audio");
                audios.forEach(
                    audio => {
                        console.log(audio);
                        audio.muted = is_muted == true ? true : false;
                    }
                );
            }
        </script>
    </body>
</html>
