<!-- 360°閲覧できるビューワーのように、WEBサイトに3Dを埋め込む例 -->
<html>
  <head>
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta charset="utf-8" />
    <meta name="author" content="エスユーエス名古屋" />
    <meta name="description" content="エスユーエス名古屋WebAR" />
    <meta property="og:image" content="" />
    <meta property="og:description" content="エスユーエス名古屋WebAR" />
    <meta property="og:title" content="エスユーエス名古屋WebAR" />
    <meta property="og:site_name" content="エスユーエス名古屋WebAR" />
    <meta property="og:locale" content="ja_JP" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta http-equiv="Pragma" content="no-store" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Expires" content="0" />
    <meta
      aframe-injected=""
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no,user-scalable=no,minimal-ui,viewport-fit=cover"
    />
    <meta aframe-injected="" name="theme-color" content="black" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />
    <meta charset="utf-8" />
    <title>エスユーエス名古屋WebAR</title>
    <!-- A-FrameをCDNから読み込む -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- aframe-orbit-controlsをCDNから読み込む -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-orbit-controls@1.3.0/dist/aframe-orbit-controls.min.js"></script>
    <script src="https://unpkg.com/aframe-supercraft-loader@1.1.3/dist/aframe-supercraft-loader.js"></script>
  </head>
  <body>
    <div id="loader">
      <p>Loading...</p>
    </div>
    <a-scene embedded arjs vr-mode-ui="enabled: false">
      <a-assets>
        <!-- 3Dモデルを読み込む -->
        <a-asset-item
          id="dragon"
          src="./obj/fukui/WalkingBrakio.glb"
          scale="1 1 1"
        ></a-asset-item>
        <audio id="se" muted playinline src="./sound/dragon.mp3"></audio>
      </a-assets>

      <!-- マーカーを設定する -->
      <a-marker
        id="base"
        type="pattern"
        url="./pattern-ar-test.patt"
        emitevents="true"
      ></a-marker>

      <!-- aframe-orbit-controlsのプロパティを記述 -->
      <a-entity
        camera
        look-controls
        orbit-controls="target: 0 1.6 0; maxPolarAngle:180; minDistance: 0.5; maxDistance: 200; initialPosition: 0 0 40"
      ></a-entity>

      <!-- 3Dモデルを読み込んで、位置やスケールなど定義する -->
      <a-entity
        visible="false"
        gltf-model="#dragon"
        id="test"
        position="0 -3 0"
        rotation="0 5 5"
        scale="100 100 100"
        animation-mixer
      ></a-entity>

      <!-- スタートモーダル -->
      <div
        id="info-message"
        class="a-info-message d-flex align-items-center rounded"
      >
        <div id="close-btn" class="a-close-button-info">X</div>
        <div class="w-100 text-center">
          <img
            src="./img/sus.png"
            alt="susロゴ"
            width="90%"
            style="display: block"
          /><br />
          <p class="fw-bold">エスユーエス名古屋WebARデモ</p>
          <p class="fw-bold">カメラでマーカーを読み込んでください。</p>
          <p class="fw-bold">回転・拡大縮小デモ</p>
          <button id="start-btn" type="button" class="btn btn-primary btn-lg">
            スタート!!
          </button>
        </div>
      </div>
    </a-scene>
  </body>
  <script>
    let testEntityAdded = false;
    let markerLostflg = false;

    //glTFの表示が暗くなる問題に対処
    document.querySelector("a-scene").renderer.gammaOutput = true;

    var a_scene = document.querySelector("a-scene");

    var run = function () {
      //glTFの表示が暗くなる問題に対処
      document.querySelector("a-scene").renderer.gammaOutput = true;

      const marker = document.querySelector("a-marker");

      marker.addEventListener("markerFound", function () {
        if (!testEntityAdded) {
          console.log("markerFound");

          // 3Dモデルを追加する
          const entity = document.querySelector("#test");
          entity.setAttribute("visible", true);

          // 鳴き声
          var display_audio = document.getElementById("se");
          display_audio.pause();
          display_audio.currentTime = 0;
          display_audio.play();
        }
        testEntityAdded = true;
        markerLostflg = false;
      });

      marker.addEventListener("markerLost", function () {
        console.log("markerLost");
        markerLostflg = true;
      });

      document.getElementById("close-btn").addEventListener("click", () => {
        setMuteAudio(false); // ミュートはずし
        document.getElementById("info-message").remove();
      });
      document.getElementById("start-btn").addEventListener("click", () => {
        setMuteAudio(false); // ミュートはずし
        document.getElementById("info-message").remove();
      });
      document.getElementById("loader").classList.add("hidden");
    };

    if (a_scene.hasLoaded) {
      run();
    } else {
      window.onload = a_scene.addEventListener("loaded", run);
    }

    function setMuteAudio(is_muted) {
      var audios = document.body.querySelectorAll("audio");
      audios.forEach((audio) => {
        audio.muted = is_muted == true ? true : false;
      });
    }
  </script>
</html>
